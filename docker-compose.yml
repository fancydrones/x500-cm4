version: "3.9"
services:
  streamer:
    image: registry.gitlab.com/got.vision/rpiuav/streamer
    ports:
    - 8554:8554
    volumes:
    - /run/udev:/run/udev:ro
    privileged: true
    restart: always
    environment:
      - CAMERA_PIPELINE0=
          libcamerasrc ! 
          video/x-raw,width=1280,height=720,format=NV12,colorimetry=bt601,interlace-mode=progressive ! 
          videoflip video-direction=identity ! 
          videorate ! 
          video/x-raw,framerate=30/1 ! 
          v4l2convert ! 
          v4l2h264enc output-io-mode=2 extra-controls="controls,repeat_sequence_header=1,video_bitrate_mode=1,h264_profile=3,video_bitrate=5000000" ! 
          video/x-h264,profile=main,level=(string)4 ! 
          queue max-size-buffers=1 name=q_enc ! 
          h264parse ! 
          rtph264pay config-interval=1 name=pay0 pt=96
  router:
    image: registry.gitlab.com/got.vision/rpiuav/router
    ports:
    - 5760:5760
    - 14560:14560
    - 14561:14561
    network_mode: host
    privileged: true
    restart: always
    volumes:
    - ./mavlink-router.conf:/etc/mavlink-router/main.conf
    - /dev/serial0:/dev/serial0
  announcer:
    image: registry.gitlab.com/got.vision/rpiuav/announcer
    network_mode: host
    restart: always
    environment:
      - CAMERA_URL=rtsp://10.177.177.3:8554/video0
      - CAMERA_ID=100
      - CAMERA_NAME=Main
      - SYSTEM_HOST=127.0.0.1
      - SYSTEM_PORT=14560
      - SYSTEM_ID=1
      - MAVLINK20=1
